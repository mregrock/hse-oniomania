# hse-oniomania

## Компоненты системы

Система состоит из следующих независимых компонентов, каждый из которых работает в своем Docker-контейнере:

1.  **API Gateway (`api-gateway`)**
    *   Принимает HTTP-запросы и, основываясь на пути запроса (например, `/api/v1/orders/...`), перенаправляет их соответствующему микросервису (`order-service` в данном случае). Реализован с помощью **Spring Cloud Gateway**.

2.  **Сервис Заказов (`order-service`)**
    *   Управляет жизненным циклом заказов. Отвечает за создание, хранение и обновление статусов заказов.
    *   После создания нового заказа сервис не обращается к сервису платежей напрямую. Вместо этого он публикует событие `OrderCreatedEvent` в топик Kafka. Это позволяет ему оставаться полностью независимым от сервиса платежей. Он также подписывается на события об итогах оплаты из другого топика, чтобы обновить статус заказа (например, на `FINISHED` или `CANCELLED`).

3.  **Сервис Платежей (`payments-service`)**
    *   Управляет счетами и балансом пользователей. Отвечает за создание счетов, пополнение баланса и списание средств.
    *   Сервис подписан на топик с событиями `OrderCreatedEvent`. Получив такое событие, он инициирует процесс оплаты. В зависимости от результата (хватило ли денег на счету), он публикует ответное событие (`PaymentSuccessEvent` или `PaymentFailedEvent`) в свой собственный топик.

4.  **Брокер сообщений (`kafka`)**
    *   Обеспечивает асинхронное взаимодействие между сервисами.
    *   Сервисы не общаются друг с другом напрямую, а обмениваются сообщениями (событиями) через топики в Kafka.

## Алгоритм обработки заказа (Событийный сценарий)

1.  **Запрос:** Внешний клиент отправляет запрос на создание заказа на `api-gateway`.
2.  **Маршрутизация:** Шлюз перенаправляет запрос в `order-service`.
3.  **Создание Заказа:** `order-service` создает заказ в своей базе данных со статусом `NEW`.
4.  **Событие 1 (Заказ создан):** `order-service` публикует событие о создании заказа в топик `orders.created` в Kafka.
5.  **Обработка Платежа:** `payments-service` получает это событие, проверяет баланс пользователя и списывает средства.
6.  **Событие 2 (Платеж обработан):** `payments-service` публикует результат операции (успех или неудача) в топик `payments.processed`.
7.  **Обновление статуса:** `order-service` получает событие из `payments.processed` и обновляет статус заказа на `FINISHED` или `CANCELLED`.

## Запуск и тестирование

*   **Запуск системы:** `docker-compose up --build -d`
*   **Тестирование:** Все запросы следует отправлять на `api-gateway`: `http://localhost:8088`.
*   **Документация API (Swagger):**
    *   **Order Service:** `http://localhost:8080/swagger-ui.html`
    *   **Payments Service:** `http://localhost:8081/swagger-ui.html`

## Примеры запросов

### Успешная покупка

1.  **Создаем счет для пользователя с ID=1337:**
    ```bash
    curl -X POST -H "Content-Type: application/json" -d '{"userId": 1337}' http://localhost:8088/api/v1/payments/accounts
    ```

2.  **Пополняем его счет на 1000:**
    ```bash
    curl -X POST -H "Content-Type: application/json" -d '{"amount": 1000}' http://localhost:8088/api/v1/payments/accounts/1337/deposit
    ```

3.  **Создаем заказ на 200:**
    ```bash
    curl -X POST -H "Content-Type: application/json" -d '{"userId": 1337, "description": "My test order", "amount": 200}' http://localhost:8088/api/v1/orders
    ```
    *В ответе вы увидите ID заказа, например, `"id":1`.*

4.  **Проверяем статус заказа (подождите пару секунд):**
    ```bash
    # Подставьте ID вашего заказа вместо 1
    curl http://localhost:8088/api/v1/orders/1
    ```
    *Статус должен поменяться с `NEW` на `FINISHED`.*

5.  **Проверяем итоговый баланс:**
    ```bash
    curl http://localhost:8088/api/v1/payments/accounts/1337
    ```
    *Баланс должен стать 800.*

### Сценарий с недостаточным балансом

Пример показывает, что произойдет, если попытаться купить что-то, на что не хватает денег.

1.  **Создаем пользователя и пополняем счет всего на 50:**
    ```bash
    curl -X POST -H "Content-Type: application/json" -d '{"userId": 111}' http://localhost:8088/api/v1/payments/accounts
    
    curl -X POST -H "Content-Type: application/json" -d '{"amount": 50}' http://localhost:8088/api/v1/payments/accounts/111/deposit
    ```

2.  **Пытаемся сделать заказ на 100 (денег не хватит):**
    ```bash
    # ID заказа произвольный
    curl -X POST -H "Content-Type: application/json" -d '{"userId": 111, "description": "Expensive order", "amount": 100}' http://localhost:8088/api/v1/orders
    ```

3.  **Проверяем статус заказа и баланс через 15 секунд:**
    ```bash
    # Подставьте ID заказа, полученный на предыдущем шаге
    curl http://localhost:8088/api/v1/orders/{ID_ЗАКАЗА}
    # Ожидаемый результат: статус заказа будет "CANCELLED"
    
    curl http://localhost:8088/api/v1/payments/accounts/111
    # Ожидаемый результат: баланс останется 50, так как списание не произошло
    ```
